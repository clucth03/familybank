<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Family Bank</title>

<style>
:root{
  --bg:#fdfdfd;
  --card:#ffffff;
  --border:#e6e6e6;
  --accent:#4f46e5; /* main blue */
  --green:#10b981;
  --pink:#ec4899;
  --yellow:#f59e0b;
  --sky:#0ea5e9;
  --muted:#6b7280;
}

*{box-sizing:border-box;}
body{
  margin:0;
  padding:14px;
  font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue","YuGothic",sans-serif;
  background:var(--bg);
  color:#111;
  font-size:16px;
}

/* カード */
.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 4px 10px rgba(0,0,0,0.06);
}

/* sticky summary */
.sticky-summary{
  position:sticky;
  top:0;
  z-index:99;
}

/* heading */
h1{margin:0;font-size:24px;font-weight:700;}
h2{margin:0 0 10px;font-size:20px;font-weight:700;}

.subtext{
  font-size:13px;
  color:var(--muted);
}

/* inputs */
select,button{
  font-size:16px;
  padding:10px 14px;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
}

button.primary{
  background:var(--accent);
  color:#fff;
  border:none;
}

/* summary area */
.summary{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:12px;
}
.summary-item{
  flex:1 1 140px;
  background:#f3f4f6;
  border-radius:12px;
  padding:12px;
}
.summary-item .value{
  display:block;
  font-size:20px;
  font-weight:700;
  margin-top:4px;
}

/* task table */
table{
  width:100%;
  border-collapse:collapse;
  font-size:16px;
}
th,td{
  padding:12px 6px;
  border-bottom:1px solid var(--border);
}
th{
  text-align:left;
  font-size:16px;
  font-weight:700;
}
td.reward{
  text-align:right;
  font-size:18px;
  font-weight:700;
}
td.control{
  width:120px;
  text-align:center;
}

.task-name{
  font-size:16px;
  font-weight:700;
}
.desc{
  font-size:13px;
  color:var(--muted);
  margin-top:2px;
}

/* --- チェック式ボタン（色付き） --- */
.check-btn{
  width:48px;
  height:48px;
  border-radius:50%;
  border:none;
  background:#e5e7eb;
  font-size:20px;
  font-weight:700;
  cursor:pointer;
  transition:0.2s;
}
.check-btn.active{
  background:var(--green);
  color:#fff;
}

/* --- 回数式カウンター --- */
.counter-wrap{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:6px;
}
.counter-btn{
  width:40px;
  height:40px;
  border-radius:50%;
  border:none;
  background:#e5e7eb;
  font-size:24px;
  font-weight:700;
  cursor:pointer;
}
.counter-count{
  font-size:18px;
  font-weight:700;
  width:40px;
  text-align:center;
}

/* tabs */
.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}
.tab-btn{
  flex:1;
  text-align:center;
  padding:10px 0;
  border-radius:12px;
  border:1px solid var(--border);
  background:#fff;
  font-size:16px;
}
.tab-btn.active{
  background:var(--accent);
  color:#fff;
  border-color:var(--accent);
}
.tab-content{display:none;}
.tab-content.active{display:block;}

/* history */
.history-group{
  margin-top:12px;
  padding-top:10px;
  border-top:1px dashed var(--border);
}
.history-title{
  font-size:18px;
  font-weight:700;
  margin-bottom:6px;
}
.history-row{
  font-size:16px;
  display:flex;
  justify-content:space-between;
  margin:4px 0;
}
.empty-text{
  font-size:14px;
  color:var(--muted);
  margin-top:8px;
}

/* weekly detail */
.week-date-title{
  font-size:18px;
  font-weight:700;
  padding:10px;
  background:#f3f4f6;
  border-radius:10px;
  margin-top:12px;
  cursor:pointer;
}
.week-task-line{
  padding:6px 10px;
  font-size:16px;
  border-bottom:1px solid #eee;
}
</style>
</head>

<body>

<!-- タブメニュー -->
<div class="card">
  <div class="tabs">
    <button class="tab-btn active" data-tab="main">今日のタスク</button>
    <button class="tab-btn" data-tab="month">月のきろく</button>
    <button class="tab-btn" data-tab="week">週のきろく</button>
  </div>
</div>

<!-- 今日タブ -->
<div id="tab-main" class="tab-content active">
  <div class="card sticky-summary">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div>
        <h1>Family Bank</h1>
        <div class="subtext">カラフルで見やすい子ども向けバージョン</div>
      </div>

      <div>
        <label for="childSelect" style="font-size:14px;">子ども：</label>
        <select id="childSelect">
          <option value="Cocoro">Cocoro</option>
          <option value="Sota">Sota</option>
          <option value="Eight">Eight</option>
        </select>
      </div>
    </div>

    <div class="summary">
      <div class="summary-item">今日 <span id="todayLabel" class="value"></span></div>
      <div class="summary-item">今日の合計 <span id="todayTotal" class="value">¥0</span></div>
      <div class="summary-item">今週の合計 <span id="weekTotal" class="value">¥0</span></div>
      <div class="summary-item">今月の合計 <span id="monthTotal" class="value">¥0</span></div>
    </div>

    <div style="margin-top:12px;">
      <button id="resetTodayBtn">今日の入力をリセット</button>
      <button id="resetChildAllBtn">この子の全データを消去</button>
    </div>
  </div>
    <!-- タスク一覧（今日タブ） -->
  <div class="card">
    <h2>タスク一覧</h2>
    <table>
      <thead>
        <tr>
          <th>タスク名</th>
          <th class="reward">報酬</th>
          <th class="control">入力</th>
        </tr>
      </thead>
      <tbody id="taskTableBody"></tbody>
    </table>
  </div>
</div> <!-- /tab-main -->


<!-- 月タブ -->
<div id="tab-month" class="tab-content">
  <div class="card">
    <h2>月のきろく</h2>
    <div id="monthHistoryList">読み込み中…</div>
  </div>
</div>


<!-- 週タブ -->
<div id="tab-week" class="tab-content">
  <div class="card">
    <h2>今週の合計</h2>
    <div id="weekTotalDisplay">¥0</div>
  </div>

  <!-- ▼▼▼ 週の詳細表示 ▼▼▼ -->
  <div class="card" id="weekDetailCard">
    <h2>週の記録（詳細）</h2>
    <div id="weekDetailList">
      読み込み中…
    </div>
  </div>
  <!-- ▲▲▲ 週の詳細表示ここまで ▲▲▲ -->

</div>
<script>
// =============================
// タスク定義（最新版）
// =============================
const TASKS = [
  // ------- 読書 -------
  { name:"読書・感想（Easy）", reward:300, type:"check",
    desc:"1冊読んで、しっかりと感想を書く" },
  { name:"読書・感想（Normal）", reward:1000, type:"check",
    desc:"丁寧に読み、内容を理解して自分の考えを書く" },
  { name:"読書・感想（Hard）", reward:1500, type:"check",
    desc:"深く読み込み、気づきや分析を踏まえて感想を書く" },

  // ------- 学習 -------
  { name:"調べ学習（1テーマ）", reward:500, type:"check",
    desc:"調べた内容をまとめる" },
  { name:"学習発表", reward:300, type:"check",
    desc:"なんでも良いので調べて家族の前で発表する" },

  // ------- 生活・家事 -------
  { name:"お風呂掃除（回数式）", reward:50, type:"count",
    desc:"自分の担当範囲を全部掃除する" },
  { name:"朝起き（毎日連続チャレンジ）", reward:300, type:"check",
    desc:"起こされず自分で起きる" },
  { name:"部屋の片付け（週2回以上）", reward:100, type:"check" },
  { name:"玄関掃除（週2回以上）", reward:200, type:"check" },
  { name:"皿拭き・片付け（回数式）", reward:50, type:"count",
    desc:"道具の後片付け・拭き上げ・しまうまで" },
  { name:"上履き掃除", reward:100, type:"check",
    desc:"上履きを洗って乾かす" },

  // ------- 創造系 -------
  { name:"企画ポスター", reward:300, type:"check" },
  { name:"手紙クリエイティブ", reward:100, type:"check" },
  { name:"動画作成（インスタ用）", reward:500, type:"check" },

  // ------- 社会性 -------
  { name:"新しいタスク案（2案で1000円・1案で500円）", reward:1000, type:"check" },
  { name:"公共マナー実践", reward:150, type:"check" },
  { name:"困っている人の手助け", reward:150, type:"check" },
  { name:"勉強を教えてあげる・宿題チェック（週）", reward:300, type:"check",
    desc:"家族の勉強サポート／宿題チェックをした週に記録" },

  // ------- 情緒・マインド -------
  { name:"感謝ノート（毎日）", reward:100, type:"check",
    desc:"小さなことでも感謝を見つけて日付と書く" },
  { name:"自己肯定ワーク", reward:100, type:"check",
    desc:"良いところを書き出す（週3回以上）" },
  { name:"怒らないデー", reward:200, type:"check" },
  { name:"サッカー・HC・バスケノート（1週達成）", reward:100, type:"check" },

  // ------- 経営・数字 -------
  { name:"支出記録（月で）", reward:100, type:"check" }
];

// =============================
// ローカルストレージ
// =============================
function loadData(){
  return JSON.parse(localStorage.getItem("familyBank")||"{}");
}
function saveData(data){
  localStorage.setItem("familyBank",JSON.stringify(data));
}

// =============================
// 日付関係
// =============================
function getTodayKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function getMonthKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}`;
}

// 週キーは “日付から週番号を計算” に変更（安定）
function getWeekNumber(date){
  const firstDay=new Date(date.getFullYear(), date.getMonth(), 1);
  return Math.ceil((date.getDate() + firstDay.getDay()) / 7);
}
function getCurrentWeekKey(){
  const d=new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-W${getWeekNumber(d)}`;
}

// =============================
// タスク一覧を描画
// =============================
function renderTasks(){
  const body=document.getElementById("taskTableBody");
  body.innerHTML="";

  TASKS.forEach(task=>{
    const tr=document.createElement("tr");

    const nameTd=document.createElement("td");
    nameTd.innerHTML=`
      <div class="task-name">${task.name}</div>
      ${task.desc?`<div class="desc">${task.desc}</div>`:""}
    `;
    tr.appendChild(nameTd);

    const rewardTd=document.createElement("td");
    rewardTd.className="reward";
    rewardTd.textContent=`¥${task.reward}`;
    tr.appendChild(rewardTd);

    const controlTd=document.createElement("td");
    controlTd.className="control";

    // チェック式
    if(task.type==="check"){
      const btn=document.createElement("button");
      btn.className="check-btn";
      btn.textContent="✔";

      btn.onclick=()=>{
        btn.classList.toggle("active");
        addRecord(task, btn.classList.contains("active")?1:-1);
      };

      controlTd.appendChild(btn);
    }

    // 回数式
    if(task.type==="count"){
      const wrap=document.createElement("div");
      wrap.className="counter-wrap";

      const minus=document.createElement("button");
      minus.className="counter-btn";
      minus.textContent="−";

      const plus=document.createElement("button");
      plus.className="counter-btn";
      plus.textContent="+";

      const count=document.createElement("div");
      count.className="counter-count";
      count.textContent="0";

      minus.onclick=()=>{
        const v=Number(count.textContent);
        if(v>0){
          count.textContent=v-1;
          addRecord(task,-1);
        }
      };
      plus.onclick=()=>{
        const v=Number(count.textContent);
        count.textContent=v+1;
        addRecord(task,1);
      };

      wrap.appendChild(minus);
      wrap.appendChild(count);
      wrap.appendChild(plus);
      controlTd.appendChild(wrap);
    }

    tr.appendChild(controlTd);
    body.appendChild(tr);
  });
}

// =============================
// 記録追加（name + reward 保存）
// =============================
function addRecord(task,count){
  const child=document.getElementById("childSelect").value;
  const data=loadData();
  const today=getTodayKey();

  if(!data[child]) data[child]={};
  if(!data[child][today]) data[child][today]=[];

  if(count>0){
    for(let i=0;i<count;i++){
      data[child][today].push({name:task.name, reward:task.reward});
    }
  }else{
    data[child][today].pop();
  }

  saveData(data);
  updateSummary();
  renderWeekDetail();
}

// =============================
// 合計表示（★ NaNバグ完全修正）
// =============================
function updateSummary(){
  const child=document.getElementById("childSelect").value;
  const data=loadData();
  const todayKey=getTodayKey();
  const monthKey=getMonthKey();
  const weekKey=getCurrentWeekKey();

  let todayTotal=0, weekTotal=0, monthTotal=0;

  if(data[child]){
    Object.keys(data[child]).forEach(dateKey=>{
      const records=data[child][dateKey];

      const daySum=records.reduce((sum,r)=>sum + Number(r.reward), 0);

      // 今日
      if(dateKey===todayKey) todayTotal += daySum;

      // 月の合計
      if(dateKey.startsWith(monthKey)) monthTotal += daySum;

      // 週の合計
      if(getWeekKeyFromDate(dateKey) === weekKey){
        weekTotal += daySum;
      }
    });
  }

  document.getElementById("todayLabel").textContent=todayKey;
  document.getElementById("todayTotal").textContent=`¥${todayTotal}`;
  document.getElementById("monthTotal").textContent=`¥${monthTotal}`;
  document.getElementById("weekTotal").textContent=`¥${weekTotal}`;
  document.getElementById("weekTotalDisplay").textContent=`¥${weekTotal}`;
}

// 日付文字列から週キーを作る関数
function getWeekKeyFromDate(dateStr){
  const [y,m,d]=dateStr.split("-").map(Number);
  const dt=new Date(y,m-1,d);
  return `${y}-${m}-W${getWeekNumber(dt)}`;
}

// =============================
// 週の詳細表示（①日ごと）
// =============================
function renderWeekDetail(){
  const child=document.getElementById("childSelect").value;
  const data=loadData();
  const weekKey=getCurrentWeekKey();
  const container=document.getElementById("weekDetailList");

  container.innerHTML="";

  if(!data[child]){
    container.innerHTML="<div class='empty-text'>記録なし</div>";
    return;
  }

  const weekData={};

  // 週のデータ抽出
  Object.keys(data[child]).forEach(dateKey=>{
    if(getWeekKeyFromDate(dateKey)===weekKey){
      weekData[dateKey]=data[child][dateKey];
    }
  });

  if(Object.keys(weekData).length===0){
    container.innerHTML="<div class='empty-text'>今週の記録はありません</div>";
    return;
  }

  // 日付ソート（新しい順）
  const dates=Object.keys(weekData).sort((a,b)=>new Date(b)-new Date(a));

  dates.forEach(date=>{
    const title=document.createElement("div");
    title.className="week-date-title";
    title.textContent=date;

    const detail=document.createElement("div");
    detail.style.display="none";

    weekData[date].forEach(r=>{
      const line=document.createElement("div");
      line.className="week-task-line";
      line.textContent=`・${r.name}　¥${r.reward}`;
      detail.appendChild(line);
    });

    title.onclick=()=>{
      detail.style.display = detail.style.display==="none" ? "block" : "none";
    };

    container.appendChild(title);
    container.appendChild(detail);
  });
}

// =============================
// タブ切り替え
// =============================
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));

    btn.classList.add("active");
    document.getElementById("tab-"+btn.dataset.tab).classList.add("active");

    if(btn.dataset.tab==="week") renderWeekDetail();
  };
});

// 初期表示
renderTasks();
updateSummary();
renderWeekDetail();
function resetToday(){
  const child=document.getElementById("childSelect").value;
  const data=loadData();
  const today=getTodayKey();

  if(data[child] && data[child][today]){
    delete data[child][today];
    saveData(data);
  }
  updateSummary();
  renderWeekDetail();
  alert("今日の記録をリセットしました");
}
function resetChildAll(){
  const child=document.getElementById("childSelect").value;
  const data=loadData();

  if(data[child]){
    delete data[child];
    saveData(data);
  }
  updateSummary();
  renderWeekDetail();
  alert("この子の全データを削除しました");
}
document.getElementById("resetTodayBtn").onclick = resetToday;
document.getElementById("resetChildAllBtn").onclick = resetChildAll;


</script>
</body>
</html>